var KIJ2013=(function(k,g,u){var m={key:"preferences"},q="preferences",f,e,a,i,p=["news","events","map","radio","learn","barcode","settings"],o,t=function(x){i=u({name:q},function(){this.get("preferences",function(y){if(y){m=y}if(typeof x=="function"){x()}})});s();var w=0,v=g("#action_bar select");v.empty();for(;w<p.length;w++){v.append("<option>"+p[w].slice(0,1).toUpperCase()+p[w].slice(1)+"</option>")}v.change(function(){r(g(this).val())});a=g("#popup");f=g("#loading");o.News.init();setTimeout(function(){k.scrollTo(0,1)},0);setTimeout(function(){g("#splash").hide();g("#action_bar").show();var y=g("#news").show();if(e){e=y}},1500)},j=function(v,w){return m[v]||w||null},n=function(v,w){if(v=="key"){return}m[v]=w;i.save(m)},r=function(w){var x=g("section:visible"),v;g.each(x,function(y,z){v=g(z).attr("id");v=v.slice(0,1).toUpperCase()+v.slice(1);if(o[v]&&typeof o[v].hide=="function"){o[v].hide()}});x.hide();g("#"+w.toLowerCase()).show();l(w);if(o[w]&&typeof o[w].init=="function"){o[w].init()}b()},s=function(v){if(typeof v=="function"){g("#up-button").removeAttr("href").unbind().click(function(){v();return false});g("#up-icon").css({visibility:"visible"})}else{if(typeof v=="string"){g("#up-button").unbind().click(function(){r(v);return false});g("#up-icon").css("visibility","visible")}else{if(typeof v=="undefined"){g("#up-icon").css("visibility","hidden")}}}},l=function(w){var x=typeof w=="undefined"||w=="",v="KIJ2013";g("title").text(x?v:v+" - "+w);g("#action_bar h1").text(x?v:w)},d=function(){if(f.length==0){f=g("<div/>").attr("id","loading").text("Loading").append(g("<img/>").attr("src","img/ajax-loader.gif")).appendTo("#body")}e=g("section:visible").hide();f.show()},h=function(){if(f){f.hide()}if(e){e.show();e=null}},c=function(v){if(a.length==0){a=g("<div/>").attr("id","popup").appendTo("body")}a.text(v).show();setTimeout(function(){a.slideUp("normal")},5000)},b=function(){k.scrollTo(0,1)};o={getPreference:j,hideLoading:h,init:t,navigateTo:r,scrollTop:b,setActionBarUp:s,setPreference:n,setTitle:l,showError:c,showLoading:d};return o}(window,jQuery,Lawnchair));$(function(){KIJ2013.init()});KIJ2013.Util=(function(){var d=function(f,e){if(arguments.length<2){e=255}if(arguments.length<1){f=0}return"rgb("+((e-f)*Math.random()+f).toFixed()+","+((e-f)*Math.random()+f).toFixed()+","+((e-f)*Math.random()+f).toFixed()+")"},b=function(g,f,i,h){var e=function(j){return h?h(j[g]):j[g]};f=arguments.length==2?arguments[1]:arguments[2];i=arguments.length==2?"=":arguments[1];return function(k){var j=e(k);return i=="="?j==f:(i==">"?j>f:(i=="<"?j<f:true))}},a=function(g,e,h){var f=function(i){return h?h(i[g]):i[g]};e=typeof e=="undefined"||e;return function(k,j){var i=f(k),l=f(j);return(i<l?-1:(i>l?+1:0))*[-1,1][+!!e]}},c=function(){var g=[],l,k,e,h,f;for(h=0,k=arguments.length;h<k;h++){l=arguments[h];for(f=0,e=l.length;f<e;f++){if(g.indexOf(l[f])===-1){g.push(l[f])}}}return g};return{randomColor:d,filter:b,sort:a,merge:c}}());KIJ2013.News=(function(k,c,f){var e="feed.php?f=news.rss",j="news",i,d=false,g="list",n=function(){i=new f({name:j},function(){})},l=function(){if(!d){d=true;c.get(e,function(q){var o=[],p,r;c(q).find("item").each(function(t,s){p={key:c(s).find("guid").text(),title:c(s).find("title").text(),date:(new Date(c(s).find("pubDate").text()))/1000,description:c(s).find("content\\:encoded, encoded").text()||c(s).find("description").text()};r=c(p.description).find("img");if(r.length){p.image=c(r[0]).attr("src")}o.push(p)});i.batch(o,function(){if(g=="list"){h()}});d=false},"xml").error(function(q,o,p){k.showError("Error Fetching Items: "+o);d=false})}},b=function(p){g="item";var o=c(p.target);a(o.data("guid"))},h=function(){k.setActionBarUp();k.setTitle("News");k.scrollTop();i.all(function(o){if(o.length){o.sort(k.Util.sort("date",false));var p=c("<ul/>").attr("id","news-list").addClass("listview");c.each(o,function(r,t){var q,s,u;q=c("<li/>");s=c("<a/>").attr("id",t.key);u=c("<span/>").text(t.title);s.append(u);s.data("guid",t.key);s.click(b);if(r==0){q.css({width:"100%"});s.css({height:"140px"})}if(t.image){s.css({backgroundImage:"url("+t.image+")"})}s.css({backgroundColor:k.Util.randomColor(128)});q.append(s);p.append(q)});c("#news").empty().append(p);k.hideLoading()}else{k.showLoading()}})},a=function(o){k.setActionBarUp(function(){g="list";h()});i.get(o,function(q){var p=c("<div/>").css({padding:"10px"});k.setTitle(q.title);c("<h1/>").text(q.title).appendTo(p);p.append(q.description);c("#news").empty().append(p);k.scrollTop()})},m={};m.init=function(){n();l();h()};return m}(KIJ2013,jQuery,Lawnchair));KIJ2013.Events=(function(i,d,f){var b="events.json",h="events",g,m=function(){g=new f({name:h},function(){})},k=function(){d.get(b,function(p){var n=[],o;d(p).each(function(r,q){o={key:q.guid,title:q.title,date:q.date,category:q.category,remind:!!q.remind,description:q.description};g.get(q.guid,function(s){if(s){o.remind=s.remind}});n.push(o)});g.batch(n,function(){e()})},"json").error(function(p,n,o){i.showError("Error Fetching Events: "+n)})},c=function(){j(d(this).data("guid"))},a=function(p){var n=p.data.guid,o="active btn-success",q=d(this).toggleClass(o).hasClass(o);g.get(n,function(r){r.remind=q;g.save(r)});return false},e=function(){i.setActionBarUp();i.setTitle("Events");var n=i.getPreference("subcamp");g.all(function(u){var s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t,p,v,w,q,r,x,y,o;if(u.length){u=u.filter(i.Util.filter("date",">",(new Date())/1000));if(n){u=i.Util.merge(u.filter(i.Util.filter("category",n)),u.filter(i.Util.filter("category","all")))}u.sort(i.Util.sort("date"));t=d("<ul/>").attr("id","event-list").addClass("listview");d.each(u,function(z,A){v=A.key;w=d("<li/>");p=d("<a/>").attr("id",v);q=new Date(A.date*1000);r=d("<p/>").addClass("date-text").text(q.getDate()+" "+s[q.getMonth()]);x=d("<p/>").addClass("title").text(A.title);y=d("<a/>").addClass("remind-btn btn").addClass(A.remind?"active btn-success":"").text("Remind").click({guid:v},a);o=d("<p/>").addClass("category").text(A.category);p.data("guid",v);p.click(c);p.append(r).append(x).append(y).append(o);w.append(p);t.append(w)});d("#events").empty().append(t);i.hideLoading()}else{i.showLoading()}})},j=function(n){i.setActionBarUp(e);i.scrollTop();g.get(n,function(q){if(q){var p=d("<div/>").css({padding:"10px"}),o=new Date(q.date*1000);i.setTitle(q.title);d("#events").empty();d("<h1/>").text(q.title).appendTo(p);d("<p/>").addClass("date-text").text(o.toLocaleString()).appendTo(p);d("<a/>").addClass("btn").addClass(q.remind?"active btn-success":"").text("Remind").click({guid:n},a).appendTo(p);d("<p/>").attr("id","remind-text").text(q.remind?"You will be reminded about this event.":"You will not be reminded about this event").appendTo(p);d("<p/>").addClass("category").text(q.category).appendTo(p);d("<p/>").text(q.description).appendTo(p);d("#events").append(p)}})},l={};l.init=function(){m();e();k()};return l}(KIJ2013,jQuery,Lawnchair));KIJ2013.Map=(function(n,f,l){var c=[0.5785846710205073,51.299361979488744,0.5925965309143088,51.305519711648124],h=[2516,1867],m=h[0]/(c[2]-c[0]),a=h[1]/(c[3]-c[1]),g,e,k=false,i=function(r){if(r<c[0]){throw"OutOfBounds"}if(r>c[2]){throw"OutOfBounds"}return(r-c[0])*m},b=function(r){if(r<c[1]){throw"OutOfBounds"}if(r>c[3]){throw"OutOfBounds"}return(r-c[1])*a},q=function(){var r=l.geolocation;if(!k){g=f("#map img");if(g.length==0){n.showLoading();g=f("<img />").attr("src","img/map.png").appendTo("#map").load(function(){n.Map.moveTo(51.3015,0.584);n.hideLoading()})}e=f("#marker");k=true}else{n.Map.moveTo(51.3015,0.584)}if(r){r.getCurrentPosition(function(s){var t=s.coords,u=t.latitude,v=t.longitude;n.Map.mark(u,v);setTimeout(function(){n.Map.moveTo(u,v)},2)},function(){n.showError("Error Finding Location")})}},o=function(w,z){try{var v=f(window),s=v.height(),t=v.width(),r=i(z)-t/2,A=h[1]-b(w)-s/2;setTimeout(function(){window.scrollTo(r,A)},10)}catch(u){}},d=function(s,t){try{e.css({display:"block",bottom:b(s),left:i(t)})}catch(r){}},j=function(){e.css({display:"none"})},p={init:q,moveTo:o,mark:d,unmark:j};return p}(KIJ2013,$,navigator));KIJ2013.Radio=(function(d,f){var c=false,e,b="http://176.227.210.187:8046/;stream=1",a={};a.init=function(){if(!c){e=f("#player").jPlayer({cssSelectorAncestor:"#controls",nativeSupport:true,ready:function(){e.jPlayer("setMedia",{mp3:b}).jPlayer("play")},swfPath:"swf",volume:60,errorAlerts:true});c=true}d.setTitle("Radio")};return a}(KIJ2013,jQuery));KIJ2013.Learn=(function(l,e,h){var k="learn",c="learn.php?id=",m="learn-",i,j,q=function(){j=new h({name:k},function(){})},a=function(){g(e(this).data("guid"))},f=function(){l.setActionBarUp();l.setTitle("Learn");l.scrollTop();j.all(function(s){var r=s.length,t;if(r){t=e("<ul/>").attr("id","learn-list").addClass("listview");s.sort(l.Util.sort("date",false));e.each(s,function(v,x){var w,u,y,z;z=x.key;u=e("<li/>").attr("id",m+z);y=x.title||"* New item";w=e("<a/>").text(y);w.data("guid",z);w.click(a);if(z==i){u.addClass("highlight");i=null}u.append(w);t.append(u)});e("#learn").empty().append(t)}})},g=function(r){l.setActionBarUp(f);l.scrollTop();j.get(r,function(t){if(t){var s=e("<div/>").css({padding:"10px"});if(!t.description){l.showLoading();b(r,function(){l.hideLoading();g(r)},function(){l.hideLoading();l.showError("Sorry, Could not find any information on that item.");f()})}else{l.setTitle(t.title);e("<h1/>").text(t.title).appendTo(s);s.append(t.description);e("#learn").empty().append(s)}}})},b=function(t,s,r){e.get(c+t,function(u){j.get(t,function(v){v.title=u.title;v.description=u.description;j.save(v)})}).success(s).error(r)},p=function(){q();f()},o=function(r){if(!j){q()}j.get(r,function(s){if(!s){j.save({key:r,date:(new Date())/1000})}})},d=function(t){var s=e("#"+m+t),r="highlight";if(s.length){s.addClass(r);setTimeout(function(){s.removeClass(r)},3000)}else{i=t}},n={init:p,add:o,highlight:d};return n}(KIJ2013,jQuery,Lawnchair));KIJ2013.Barcode=(function(n,j,a){var e=$("#live")[0],g=$("<canvas>")[0],q=g.getContext("2d"),h=null,m=typeof qrcode!=="undefined"?qrcode:false,f,l,p=function(){g.width=640;g.height=480;a.getUserMedia||(a.getUserMedia=a.webkitGetUserMedia);j.URL||(j.URL=j.webkitURL||j.msURL||j.oURL);if(a.getUserMedia){if(!l){a.getUserMedia({video:true},function(r){e.src=c(r);h=r;l=true;n.Barcode.start()},function(r){console.log("Unable to get video stream!")})}else{n.Barcode.start()}}else{n.showError("Barcode Scanner is not available on your platform.")}},c=function(r){return(j.URL&&j.URL.createObjectURL)?j.URL.createObjectURL(r):r},b=function(){if(h&&m){q.drawImage(e,0,0);m.decode(g.toDataURL("image/webp"))}},d=function(){e.play();if(f){clearInterval(f)}f=setInterval(b,1000)},k=function(){e.pause();clearInterval(f)},i=function(){n.Barcode.stop()},o;if(m){m.callback=function(r){if(r){var s=r.slice(26);if(r.slice(0,26)=="http://kij13.org.uk/learn/"){n.Barcode.stop();n.Learn.add(s);alert("Congratulations you found an item.");n.navigateTo("Learn");n.Learn.highlight(s)}else{alert(r)}}}}o={init:p,start:d,stop:k,hide:i};return o}(KIJ2013,window,navigator));KIJ2013.Settings=(function(i,b,d){var c="news",a="events",f="learn",h="preferences",g,e=false,j={};j.init=function(){if(!e){g=b("#subcamp");g.val(i.getPreference("subcamp"));g.change(function(){var k=g.val();i.setPreference("subcamp",k)});b("#clear-cache").click(function(){var k=0;d({name:c},function(){this.nuke();if(++k==3){alert("Cache Cleared")}});d({name:a},function(){this.nuke();if(++k==3){alert("Cache Cleared")}});d({name:f},function(){this.nuke();if(++k==3){alert("Cache Cleared")}})});b("#clear-preferences").click(function(){d({name:h},function(){this.nuke();g.val("");alert("Preferences Cleared")})});e=true}};return j}(KIJ2013,jQuery,Lawnchair));