var KIJ2013=function(){var c={key:"preferences"},g="preferences",f,d,a,b,e=["news","events","map","radio","learn","barcode","settings"];return{init:function(k){b=Lawnchair({name:g},function(){this.get("preferences",function(i){if(i){c=i}if(typeof k=="function"){k()}})});KIJ2013.setActionBarUp();var j=0,h=$("#action_bar select");h.empty();for(;j<e.length;j++){h.append("<option>"+e[j].slice(0,1).toUpperCase()+e[j].slice(1)+"</option>")}h.change(function(){KIJ2013.navigateTo($(this).val())});a=$("#popup");f=$("#loading");KIJ2013.News.init();setTimeout(function(){window.scrollTo(0,1)},0);setTimeout(function(){$("#splash").hide();$("#action_bar").show();var i=$("#news").show();if(d){d=i}},1500)},getPreference:function(h,i){return c[h]||i||null},setPreference:function(h,i){if(h=="key"){return}c[h]=i;b.save(c)},navigateTo:function(i){var j=$("section:visible"),h;$.each(j,function(k,l){h=$(l).attr("id");h=h.slice(0,1).toUpperCase()+h.slice(1);if(KIJ2013[h]&&typeof KIJ2013[h].hide=="function"){KIJ2013[h].hide()}});j.hide();$("#"+i.toLowerCase()).show();KIJ2013.setTitle(i);if(KIJ2013[i]&&typeof KIJ2013[i].init=="function"){KIJ2013[i].init()}KIJ2013.scrollTop()},setActionBarUp:function(h){if(typeof h=="function"){$("#up-button").removeAttr("href").unbind().click(function(){h();return false});$("#up-icon").css({visibility:"visible"})}else{if(typeof h=="string"){$("#up-button").unbind().click(function(){KIJ2013.navigateTo(h);return false});$("#up-icon").css("visibility","visible")}else{if(typeof h=="undefined"){$("#up-icon").css("visibility","hidden")}}}},setTitle:function(i){var j=typeof i=="undefined"||i=="",h="KIJ2013";$("title").text(j?h:h+" - "+i);$("#action_bar h1").text(j?h:i)},showLoading:function(){if(f.length==0){f=$("<div/>").attr("id","loading").text("Loading").append($("<img/>").attr("src","img/ajax-loader.gif")).appendTo("#body")}d=$("section:visible").hide();f.show()},hideLoading:function(){if(f){f.hide()}if(d){d.show();d=null}},showError:function(h){if(a.length==0){a=$("<div/>").attr("id","popup").appendTo("body")}a.text(h).show();setTimeout(function(){a.slideUp("normal")},5000)},scrollTop:function(){window.scrollTo(0,1)}}}();KIJ2013.Util=function(){return{randomColor:function(b,a){if(arguments.length<2){a=255}if(arguments.length<1){b=0}return"rgb("+((a-b)*Math.random()+b).toFixed()+","+((a-b)*Math.random()+b).toFixed()+","+((a-b)*Math.random()+b).toFixed()+")"},filter:function(c,b,e,d){var a=function(f){return d?d(f[c]):f[c]};b=arguments.length==2?arguments[1]:arguments[2];e=arguments.length==2?"=":arguments[1];return function(g){var f=a(g);return e=="="?f==b:(e==">"?f>b:(e=="<"?f<b:true))}},sort:function(c,a,d){var b=function(e){return d?d(e[c]):e[c]};a=typeof a=="undefined"||a;return function(g,f){var e=b(g),h=b(f);return(e<h?-1:(e>h?+1:0))*[-1,1][+!!a]}},merge:function(){var c=[],f,e,a,d,b;for(d=0,e=arguments.length;d<e;d++){f=arguments[d];for(b=0,a=f.length;b<a;b++){if(c.indexOf(f[b])===-1){c.push(f[b])}}}return c}}}();$(function(){KIJ2013.init()});KIJ2013.News=function(){var d="feed.php?f=news.rss",h="news",g,c=false,e="list",j=function(){g=new Lawnchair({name:h},function(){})},i=function(){if(!c){c=true;$.get(d,function(m){var k=[],l,n;$(m).find("item").each(function(p,o){l={key:$(o).find("guid").text(),title:$(o).find("title").text(),date:(new Date($(o).find("pubDate").text()))/1000,description:$(o).find("content\\:encoded, encoded").text()||$(o).find("description").text()};n=$(l.description).find("img");if(n.length){l.image=$(n[0]).attr("src")}k.push(l)});g.batch(k,function(){if(e=="list"){f()}});c=false},"xml").error(function(m,k,l){KIJ2013.showError("Error Fetching Items: "+k);c=false})}},b=function(l){e="item";var k=$(l.target);a(k.data("guid"))},f=function(){KIJ2013.setActionBarUp();KIJ2013.setTitle("News");KIJ2013.scrollTop();g.all(function(k){if(k.length){k.sort(KIJ2013.Util.sort("date",false));var l=$("<ul/>").attr("id","news-list").addClass("listview");$.each(k,function(n,p){var m,o,q;m=$("<li/>");o=$("<a/>").attr("id",p.key);q=$("<span/>").text(p.title);o.append(q);o.data("guid",p.key);o.click(b);if(n==0){m.css({width:"100%"});o.css({height:"140px"})}if(p.image){o.css({backgroundImage:"url("+p.image+")"})}o.css({backgroundColor:KIJ2013.Util.randomColor(128)});m.append(o);l.append(m)});$("#news").empty().append(l);KIJ2013.hideLoading()}else{KIJ2013.showLoading()}})},a=function(k){KIJ2013.setActionBarUp(function(){e="list";f()});g.get(k,function(m){var l=$("<div/>").css({padding:"10px"});KIJ2013.setTitle(m.title);$("<h1/>").text(m.title).appendTo(l);l.append(m.description);$("#news").empty().append(l);KIJ2013.scrollTop()})};return{init:function(){j();i();f()}}}();KIJ2013.Events=function(){var b="events.json",f="events",e,i=function(){e=new Lawnchair({name:f},function(){})},h=function(){$.get(b,function(l){var j=[],k;$(l).each(function(n,m){k={key:m.guid,title:m.title,date:m.date,category:m.category,remind:!!m.remind,description:m.description};e.get(m.guid,function(o){if(o){k.remind=o.remind}});j.push(k)});e.batch(j,function(){d()})},"json").error(function(l,j,k){KIJ2013.showError("Error Fetching Events: "+j)})},c=function(){g($(this).data("guid"))},a=function(l){var j=l.data.guid,k="active btn-success",m=$(this).toggleClass(k).hasClass(k);e.get(j,function(n){n.remind=m;e.save(n)});return false},d=function(){KIJ2013.setActionBarUp();KIJ2013.setTitle("Events");var j=KIJ2013.getPreference("subcamp");e.all(function(q){var o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p,l,r,s,m,n,t,u,k;if(q.length){q=q.filter(KIJ2013.Util.filter("date",">",(new Date())/1000));if(j){q=KIJ2013.Util.merge(q.filter(KIJ2013.Util.filter("category",j)),q.filter(KIJ2013.Util.filter("category","all")))}q.sort(KIJ2013.Util.sort("date"));p=$("<ul/>").attr("id","event-list").addClass("listview");$.each(q,function(v,w){r=w.key;s=$("<li/>");l=$("<a/>").attr("id",r);m=new Date(w.date*1000);n=$("<p/>").addClass("date-text").text(m.getDate()+" "+o[m.getMonth()]);t=$("<p/>").addClass("title").text(w.title);u=$("<a/>").addClass("remind-btn btn").addClass(w.remind?"active btn-success":"").text("Remind").click({guid:r},a);k=$("<p/>").addClass("category").text(w.category);l.data("guid",r);l.click(c);l.append(n).append(t).append(u).append(k);s.append(l);p.append(s)});$("#events").empty().append(p);KIJ2013.hideLoading()}else{KIJ2013.showLoading()}})},g=function(j){KIJ2013.setActionBarUp(d);KIJ2013.scrollTop();e.get(j,function(m){if(m){var l=$("<div/>").css({padding:"10px"}),k=new Date(m.date*1000);KIJ2013.setTitle(m.title);$("#events").empty();$("<h1/>").text(m.title).appendTo(l);$("<p/>").addClass("date-text").text(k.toLocaleString()).appendTo(l);$("<a/>").addClass("btn").addClass(m.remind?"active btn-success":"").text("Remind").click({guid:j},a).appendTo(l);$("<p/>").attr("id","remind-text").text(m.remind?"You will be reminded about this event.":"You will not be reminded about this event").appendTo(l);$("<p/>").addClass("category").text(m.category).appendTo(l);$("<p/>").text(m.description).appendTo(l);$("#events").append(l)}})};return{init:function(){i();d();h()}}}();KIJ2013.Map=function(){var c=[0.5785846710205073,51.299361979488744,0.5925965309143088,51.305519711648124],f=[2516,1867],i=f[0]/(c[2]-c[0]),a=f[1]/(c[3]-c[1]),d,e,h=false,g=function(j){if(j<c[0]){throw"OutOfBounds"}if(j>c[2]){throw"OutOfBounds"}return(j-c[0])*i},b=function(j){if(j<c[1]){throw"OutOfBounds"}if(j>c[3]){throw"OutOfBounds"}return(j-c[1])*a};return{init:function(){var j=navigator.geolocation;if(!h){d=$("#map img");if(d.length==0){KIJ2013.showLoading();d=$("<img />").attr("src","img/map.png").appendTo("#map").load(function(){KIJ2013.Map.moveTo(51.3015,0.584);KIJ2013.hideLoading()})}e=$("#marker");h=true}else{KIJ2013.Map.moveTo(51.3015,0.584)}if(j){j.getCurrentPosition(function(k){var l=k.coords,m=l.latitude,n=l.longitude;KIJ2013.Map.mark(m,n);setTimeout(function(){KIJ2013.Map.moveTo(m,n)},2)},function(){KIJ2013.showError("Error Finding Location")})}},moveTo:function(o,p){try{var n=$(window),k=n.height(),l=n.width(),j=g(p)-l/2,q=f[1]-b(o)-k/2;setTimeout(function(){window.scrollTo(j,q)},10)}catch(m){}},mark:function(k,l){try{e.css({display:"block",bottom:b(k),left:g(l)})}catch(j){}},unmark:function(){e.css({display:"none"})}}}();KIJ2013.Radio=function(){var b=false,c,a="http://176.227.210.187:8046/;stream=1";return{init:function(){if(!b){c=$("#player").jPlayer({cssSelectorAncestor:"#controls",nativeSupport:true,ready:function(){c.jPlayer("setMedia",{mp3:a}).jPlayer("play")},swfPath:"swf",volume:60,errorAlerts:true});b=true}KIJ2013.setTitle("Radio")}}}();KIJ2013.Learn=function(){var h="learn",c="learn.php?id=",i="learn-",d,g,j=function(){g=new Lawnchair({name:h},function(){})},a=function(){f($(this).data("guid"))},e=function(){KIJ2013.setActionBarUp();KIJ2013.setTitle("Learn");KIJ2013.scrollTop();g.all(function(l){var k=l.length,m;if(k){m=$("<ul/>").attr("id","learn-list").addClass("listview");l.sort(KIJ2013.Util.sort("date",false));$.each(l,function(o,q){var p,n,r,s;s=q.key;n=$("<li/>").attr("id",i+s);r=q.title||"* New item";p=$("<a/>").text(r);p.data("guid",s);p.click(a);if(s==d){n.addClass("highlight");d=null}n.append(p);m.append(n)});$("#learn").empty().append(m)}})},f=function(k){KIJ2013.setActionBarUp(e);KIJ2013.scrollTop();g.get(k,function(m){if(m){var l=$("<div/>").css({padding:"10px"});if(!m.description){KIJ2013.showLoading();b(k,function(){KIJ2013.hideLoading();f(k)},function(){KIJ2013.hideLoading();KIJ2013.showError("Sorry, Could not find any information on that item.");e()})}else{KIJ2013.setTitle(m.title);$("<h1/>").text(m.title).appendTo(l);l.append(m.description);$("#learn").empty().append(l)}}})},b=function(m,l,k){$.get(c+m,function(n){g.get(m,function(o){o.title=n.title;o.description=n.description;g.save(o)})}).success(l).error(k)};return{init:function(){j();e()},add:function(k){if(!g){j()}g.get(k,function(l){if(!l){g.save({key:k,date:(new Date())/1000})}})},highlight:function(m){var l=$("#"+i+m),k="highlight";if(l.length){l.addClass(k);setTimeout(function(){l.removeClass(k)},3000)}else{d=m}}}}();KIJ2013.Barcode=function(){var d=$("#live")[0],f=$("<canvas>")[0],k=f.getContext("2d"),g=null,a=navigator,h=window,j=typeof qrcode!=="undefined"?qrcode:false,c=function(){if(g&&j){k.drawImage(d,0,0);j.decode(f.toDataURL("image/webp"))}},b,e,i;f.width=640;f.height=480;a.getUserMedia||(a.getUserMedia=a.webkitGetUserMedia);h.URL||(h.URL=h.webkitURL||h.msURL||h.oURL);b=function(l){return(h.URL&&h.URL.createObjectURL)?h.URL.createObjectURL(l):l};if(j){j.callback=function(l){if(l){var m=l.slice(26);if(l.slice(0,26)=="http://kij13.org.uk/learn/"){KIJ2013.Barcode.stop();KIJ2013.Learn.add(m);alert("Congratulations you found an item.");KIJ2013.navigateTo("Learn");KIJ2013.Learn.highlight(m)}else{alert(l)}}}}return{init:function(){if(a.getUserMedia){if(!i){a.getUserMedia({video:true},function(l){d.src=b(l);g=l;i=true;KIJ2013.Barcode.start()},function(l){console.log("Unable to get video stream!")})}else{KIJ2013.Barcode.start()}}else{KIJ2013.showError("Barcode Scanner is not available on your platform.")}},start:function(){d.play();if(e){clearInterval(e)}e=setInterval(c,1000)},stop:function(){d.pause();clearInterval(e)},hide:function(){KIJ2013.Barcode.stop()}}}();KIJ2013.Settings=function(){var f="news",e="events",d="learn",a="preferences",c,b=false;return{init:function(){if(!b){c=$("#subcamp");c.val(KIJ2013.getPreference("subcamp"));c.change(function(){var g=c.val();KIJ2013.setPreference("subcamp",g)});$("#clear-cache").click(function(){var g=0;Lawnchair({name:f},function(){this.nuke();if(++g==3){alert("Cache Cleared")}});Lawnchair({name:e},function(){this.nuke();if(++g==3){alert("Cache Cleared")}});Lawnchair({name:d},function(){this.nuke();if(++g==3){alert("Cache Cleared")}})});$("#clear-preferences").click(function(){Lawnchair({name:a},function(){this.nuke();c.val("");alert("Preferences Cleared")})});b=true}}}}();